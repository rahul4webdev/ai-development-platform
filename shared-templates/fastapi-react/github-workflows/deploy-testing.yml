# Deploy to Testing Environment Workflow Template
# Pre-configured for CyberPanel/OpenLiteSpeed deployment
# Generated by AI Development Platform

name: Deploy to Testing Environment

on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm deployment to testing'
        required: true
        default: ''

jobs:
  verify-confirmation:
    name: Verify Deployment Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "DEPLOY" ]; then
            echo "ERROR: Deployment not confirmed. Please type 'DEPLOY' to confirm."
            exit 1
          fi
          echo "Deployment confirmed. Proceeding..."

  test-before-deploy:
    name: Run Tests Before Deployment
    needs: verify-confirmation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend linting
        working-directory: ./backend
        run: |
          black --check app tests
          flake8 app tests --max-line-length=100 --extend-ignore=E203,W503

      - name: Run backend tests with coverage
        working-directory: ./backend
        env:
          DB_USER: test_user
          DB_PASSWORD: test_password
          DATABASE: test_db
          SECRET_KEY: test-secret-key-for-ci
        run: |
          pytest --cov=app --cov-report=term-missing --cov-fail-under=70

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # FIX: Use npm install with --legacy-peer-deps
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend for testing
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://{{API_DOMAIN}}
        run: npm run build

  deploy-backend:
    name: Deploy Backend to Testing
    needs: test-before-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Prepare deployment package
        working-directory: ./backend
        run: |
          mkdir -p deploy
          cp -r app deploy/
          cp -r alembic deploy/ 2>/dev/null || true
          cp requirements.txt deploy/
          cp alembic.ini deploy/ 2>/dev/null || true

          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > deploy/DEPLOY_INFO.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> deploy/DEPLOY_INFO.txt
          echo "DEPLOYED_BY=${{ github.actor }}" >> deploy/DEPLOY_INFO.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy backend files to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./backend/deploy/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/{{API_DOMAIN}}/public_html/

      - name: Install dependencies and restart service
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /home/{{API_DOMAIN}}/public_html

          # Create virtual environment if not exists
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # Run migrations if alembic exists
          if [ -f "alembic.ini" ]; then
            alembic upgrade head
          fi

          # Restart application
          sudo systemctl restart {{PROJECT_SLUG}}-api 2>/dev/null || \
          pkill -f "uvicorn app.main:app" 2>/dev/null || true

          # Start if not running via systemd
          if ! systemctl is-active --quiet {{PROJECT_SLUG}}-api 2>/dev/null; then
            cd /home/{{API_DOMAIN}}/public_html
            source venv/bin/activate
            nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > /dev/null 2>&1 &
          fi
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  deploy-frontend:
    name: Deploy Frontend to Testing
    needs: test-before-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # FIX: Use npm install with --legacy-peer-deps
      - name: Install dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend for testing
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://{{API_DOMAIN}}
        run: |
          npm run build

          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > build/DEPLOY_INFO.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> build/DEPLOY_INFO.txt
          echo "DEPLOYED_BY=${{ github.actor }}" >> build/DEPLOY_INFO.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy frontend files to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./frontend/build/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/{{WEB_DOMAIN}}/public_html/

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  smoke-tests:
    name: Run Smoke Tests
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Wait for services to start
        run: sleep 10

      - name: Test backend health endpoint
        run: |
          curl -f https://{{API_DOMAIN}}/health || \
          curl -f https://{{API_DOMAIN}}/ || \
          echo "WARNING: Health check failed - verify manually"

      - name: Test frontend loads
        run: |
          curl -f -I https://{{WEB_DOMAIN}}/ || \
          echo "WARNING: Frontend check failed - verify manually"

  notify-completion:
    name: Notify Deployment Complete
    needs: smoke-tests
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Deployment success notification
        run: |
          echo "=========================================="
          echo "Deployment to Testing Environment Complete"
          echo "=========================================="
          echo ""
          echo "Backend API: https://{{API_DOMAIN}}"
          echo "Frontend: https://{{WEB_DOMAIN}}"
          echo "API Docs: https://{{API_DOMAIN}}/docs"
          echo ""
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Next steps:"
          echo "1. Verify deployment manually"
          echo "2. Test core user flows"
          echo "3. Approve for production if ready"
          echo "=========================================="
